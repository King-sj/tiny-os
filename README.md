# Tiny OS

一个简单的操作系统内核，用于学习操作系统基础概念。

## 运行方式

```bash
make run
```

## 项目结构

### 核心启动文件
- `src/ipl.nas` - 初始程序加载器(IPL)，引导扇区代码
- `src/asmhead.nas` - 汇编头部代码，负责模式切换和初始化
- `src/bootpack.c` - C语言主程序入口，系统初始化和主循环

### 头文件
- `src/bootpack.h` - 主头文件，包含系统基础结构定义
- `src/naskfunc.h` - 汇编函数接口声明
- `src/graphic.h` - 图形相关函数和常量定义
- `src/dsctbl.h` - 描述符表相关结构和函数声明

### 功能模块
- `src/graphic.c` - 图形界面绘制模块(调色板、屏幕绘制、字体渲染、鼠标光标)
- `src/dsctbl.c` - 描述符表管理模块(GDT/IDT初始化和设置)
- `src/sprintf.c` - 简化版sprintf实现(支持%d、%x、%s格式)

### 汇编模块
- `src/naskfunc.nas` - 汇编函数库，为C代码提供底层接口
- `src/sprintf_asm.nas` - sprintf的汇编辅助函数

### 工具文件
- `src/makefont.py` - 字体数据生成工具

## 模块功能详解

### 图形模块 (`graphic.c` / `graphic.h`)
- **调色板管理**: 初始化16色标准调色板，支持VGA 256色模式
- **屏幕绘制**: 实现桌面风格界面绘制，包括任务栏和窗口效果
- **字体渲染**: 完整的ASCII字符集显示，支持8x16像素字体
- **图形基础**: 矩形填充、块图像绘制等基础图形功能
- **鼠标光标**: 鼠标指针的初始化和绘制

### 描述符表模块 (`dsctbl.c` / `dsctbl.h`)
- **GDT管理**: 全局描述符表的初始化和段描述符设置
- **IDT管理**: 中断描述符表的初始化和中断门设置
- **内存保护**: 实现保护模式下的内存分段管理
- **段描述符**: 代码段和数据段的配置和管理

### 格式化输出模块 (`sprintf.c` / `sprintf_asm.nas`)
- **字符串格式化**: 简化但安全的sprintf实现
- **数值转换**: 支持十进制(%d)和十六进制(%x)格式
- **字符串处理**: 字符串(%s)格式支持和基础字符串操作
- **汇编优化**: 核心转换算法的汇编实现，提高性能

### 底层接口模块 (`naskfunc.nas` / `naskfunc.h`)
- **I/O操作**: 端口读写、中断控制等底层硬件接口
- **CPU控制**: HLT指令、EFLAGS寄存器操作
- **内存管理**: GDT/IDT寄存器加载等内存管理操作
- **系统延时**: 毫秒级睡眠功能实现

## 特性

### 系统启动
- ✅ 从软盘引导启动
- ✅ 实模式到保护模式切换
- ✅ VGA 320x200x256色图形模式
- ✅ 正确的内存分段管理（内核区基址：0x00280000）

### 图形系统
- ✅ 16色标准调色板支持
- ✅ 桌面风格图形界面绘制
- ✅ ASCII字符集字体渲染系统（8x16像素）
- ✅ 鼠标光标显示和定位

### 内存管理
- ✅ 全局描述符表(GDT)管理
- ✅ 中断描述符表(IDT)初始化
- ✅ 固定大小内存分配（bootpack: 32KB）
- ✅ 清晰的内存分区布局

### 系统功能
- ✅ 模块化代码架构
- ✅ 简化版sprintf功能（支持%d、%x、%s格式）
- ✅ 底层硬件接口封装
- ✅ 睡眠和延时功能

## 内存布局设计

### 段基址设置
- **数据段基址**: 0x00000000 (平坦内存模型)
- **代码段基址**: 0x00280000 (内核区起始地址)
- **跳转方式**: `JMP DWORD 2*8:0x0000` (段选择器:偏移)

这种设计的优势：
1. **明确的内存分区**: 0x280000以下为系统区，0x280000以上为内核区
2. **简化地址计算**: 物理地址 = 段基址(0x280000) + 偏移地址
3. **便于调试**: 地址含义清晰，便于内存管理

### 关键地址映射
- **0x7C00**: 引导扇区加载地址
- **0x8200**: asmhead.nas加载地址
- **0x00280000**: bootpack入口地址（段基址）
- **0xA0000**: VGA显存地址
- **0x310000**: 栈指针初始地址

## 关键Magic Number详解

### 内存地址映射

#### 引导扇区和程序加载地址
- **0x7C00**: BIOS加载引导扇区的标准地址
  - 这是IBM PC兼容机的历史约定
  - BIOS会将软盘第一扇区(512字节)加载到此地址并跳转执行

- **0x8200**: asmhead.nas的加载地址
  - IPL将从磁盘第2扇区开始的数据加载到此处
  - 选择此地址是因为它在常规内存中，远离BIOS数据区

- **0x00280000**: C代码(bootpack)的段基址
  - 使用分段内存管理，代码段基址设置为此地址
  - 实际跳转使用 `JMP DWORD 2*8:0x0000`，物理地址为 0x280000 + 0 = 0x280000

#### VGA显存地址
- **0xA0000**: VGA图形模式显存起始地址
  - 这是VGA标准定义的图形显存物理地址
  - 320x200x8位模式下，需要64KB显存(320×200=64000字节)

#### BOOT_INFO数据区地址
这些地址用于在汇编和C代码间传递系统信息：
- **0x0FF0**: 磁盘柱面数(CYLS)
- **0x0FF1**: 键盘LED状态(LEDS)
- **0x0FF2**: 显示模式(VMODE)
- **0x0FF4**: 屏幕宽度(SCRNX)
- **0x0FF6**: 屏幕高度(SCRNY)
- **0x0FF8**: 显存地址(VRAM)

这些地址位于0x0FF0-0x0FFF区域，是BIOS数据区的未使用部分。

### BIOS中断和端口

#### BIOS中断号
- **INT 0x10**: 视频服务中断
  - AH=0x00: 设置显示模式
  - AL=0x13: VGA 320x200x256色模式

- **INT 0x13**: 磁盘服务中断
  - AH=0x02: 读扇区功能
  - AH=0x00: 重置磁盘

- **INT 0x16**: 键盘服务中断
  - AH=0x02: 获取键盘状态

#### I/O端口地址
- **0x21, 0xA1**: PIC(可编程中断控制器)屏蔽寄存器
  - 用于禁用所有硬件中断
  - 0xFF表示屏蔽所有中断线

- **0x60, 0x64**: 键盘控制器端口
  - 用于启用A20地址线
  - A20地址线控制CPU能否访问1MB以上内存

- **0x03C8, 0x03C9**: VGA调色板寄存器
  - 0x03C8: 调色板索引寄存器
  - 0x03C9: 调色板数据寄存器
  - 用于设置256色模式的颜色定义

- **0x03DA**: VGA状态寄存器
  - 用于检测垂直回扫状态

### 内存分配

#### 固定大小分配
- **bootpack.bin**: 32768字节（64扇区）
  - 为C代码预留充足的空间
  - 支持未来功能扩展
- **system.bin**: 33280字节（65扇区）
  - asmhead.bin（512字节）+ bootpack.bin（32768字节）

#### 堆栈配置
- **0x310000**: 堆栈指针初始值（约3MB处）
  - 选择较高地址避免与代码和数据冲突
  - 为堆栈预留足够空间

### 调色板设置

#### 16色标准调色板
```
0: 黑色    1: 亮红    2: 亮绿    3: 亮黄
4: 亮蓝    5: 亮紫    6: 浅亮蓝  7: 白色
8: 亮灰    9: 暗红    10: 暗绿   11: 暗黄
12: 暗青   13: 暗紫   14: 浅暗蓝 15: 暗灰
```

调色板在asmhead.nas中预设，使用垂直同步等待避免闪烁问题。

### FAT12文件系统参数

引导扇区包含标准FAT12格式参数：
- **512**: 每扇区字节数
- **2880**: 1.44MB软盘总扇区数(1440KB×1024/512=2880)
- **0xF0**: 软盘介质描述符
- **224**: 根目录最大文件数
- **18**: 每磁道扇区数
- **2**: 磁头数(双面软盘)

### 引导签名
- **0x55AA**: 引导扇区签名
  - 位于扇区的最后两个字节(510-511字节)
  - BIOS通过检查此签名确认这是有效的引导扇区
  - 必须是小端序：先0x55后0xAA

### GDT(全局描述符表)相关

- **8×3-1 = 23**: GDT大小限制
  - 包含3个描述符：空描述符、数据段、代码段
  - 每个描述符8字节，共24字节，限制为23

- **0x4092, 0x409a**: 段描述符访问权限字段
  - 0x4092: 数据段(可读写)
  - 0x409a: 代码段(可执行)

- **0x00CF, 0x0047**: 段限制高4位和标志
  - 0x00CF: G位=1(4KB粒度)，D位=1(32位段)，用于数据段
  - 0x0047: G位=0(字节粒度)，D位=1(32位段)，用于代码段

## 启动流程

1. **BIOS阶段**: 加载IPL(`ipl.nas`)到0x7C00并执行
2. **IPL阶段**: 从磁盘读取system.bin到0x8200
3. **ASMHEAD阶段**(`asmhead.nas`):
   - 设置VGA 320x200x256色模式
   - 初始化系统信息结构(BOOTINFO)
   - 切换到保护模式并跳转到C代码
4. **BOOTPACK阶段**(`bootpack.c`):
   - 调用`init_gdtidt()`初始化描述符表
   - 调用`init_palette()`设置调色板
   - 调用`init_screen()`绘制桌面界面
   - 显示系统信息并进入主循环

## 调试说明

### 使用GDB调试

项目支持使用x86_64-elf-gdb进行源码级调试：

```bash
# 终端1：启动调试服务器
make debug-server

# 终端2：连接调试器
make debug-connect
```

调试器会自动：
- 连接到QEMU的gdb服务器
- 加载带调试信息的ELF文件
- 设置地址重映射（bootpack加载到0x00280000）
- 在引导扇区(0x7c00)和HariMain函数设置断点
- 显示当前指令

### 常用调试命令

```bash
# 查看符号信息
(gdb) info functions       # 所有函数
(gdb) info variables      # 全局变量
(gdb) info address HariMain  # 函数地址

# 源码级调试
(gdb) break HariMain      # 函数断点
(gdb) list               # 查看源码
(gdb) step               # 单步进入
(gdb) next               # 单步跳过
(gdb) print binfo        # 打印变量
(gdb) info locals        # 局部变量

# 内存和汇编查看
(gdb) x/10i $pc          # 查看汇编
(gdb) x/16xb 0x7c00      # 查看内存
(gdb) disas HariMain     # 反汇编函数
```

### 关键调试地址

- **0x7C00**: 引导扇区入口点
- **0x8200**: asmhead.nas加载地址
- **0x00280000**: bootpack.c入口地址（HariMain函数）
- **0xA0000**: VGA显存地址

### 调试技巧

代码中使用颜色条纹作为执行标记：
- **实模式测试**:
  - 白色(15): 第一行测试线
  - 红色(4): 第二行测试线
  - 绿色(2): 第三行测试线
- **保护模式测试**:
  - 蓝色(1): 第四行保护模式标记
- **C代码绘制**:
  - 浅暗蓝(14): 桌面背景
  - 亮灰(8): 任务栏背景
  - 白色(7): 高亮边框
  - 暗灰(15): 阴影边框
  - 黑色(0): 深阴影

## 编译说明

需要以下工具链：
- NASM: 汇编器
- x86_64-elf-gcc: 交叉编译器
- x86_64-elf-ld: 链接器
- QEMU: 虚拟机
- Python3: 字体生成工具

## 已知问题和改进空间

### 当前已实现的架构优势
- ✅ **模块化设计**: 图形、描述符表、格式化输出等功能独立成模块
- ✅ **清晰的接口**: 通过头文件明确定义模块间接口
- ✅ **代码复用**: 汇编和C代码合理分工，提高可维护性
- ✅ **功能分离**: 底层硬件操作、内存管理、图形渲染分离

### 可能的改进方向
1. **中断处理**: 添加键盘和时钟中断支持
2. **内存管理**: 实现动态内存分配器
3. **文件系统**: 完整的FAT12文件系统读取
4. **多任务**: 简单的任务切换机制
5. **GUI增强**: 窗口管理、事件处理等高级图形功能
6. **设备驱动**: 硬盘、网络等设备驱动程序

## 参考资料
- [30dayMakeOS](https://github.com/yourtion/30dayMakeOS)
- [0x86 BIOS 中断向量表](https://www.cnblogs.com/jadeshu/p/10663505.html)
- [0x86 实模式物理内存布局](https://www.cnblogs.com/HachikoT/p/16974147.html)
- [VGA硬件编程](http://www.osdever.net/FreeVGA/vga/vga.htm)
- [Intel 80386手册](https://css.csail.mit.edu/6.858/2014/readings/i386.pdf)