# Tiny OS

一个简单的操作系统内核，用于学习操作系统基础概念。

## 运行方式

```bash
make run
```

## 项目结构

- `src/ipl.nas` - 初始程序加载器(IPL)，引导扇区代码
- `src/asmhead.nas` - 汇编头部代码，负责模式切换和初始化
- `src/bootpack.c` - C语言主程序
- `src/naskfunc.nas` - 汇编函数库，为C代码提供底层接口

## 关键Magic Number详解

### 内存地址映射

#### 引导扇区和程序加载地址
- **0x7C00**: BIOS加载引导扇区的标准地址
  - 这是IBM PC兼容机的历史约定
  - BIOS会将软盘第一扇区(512字节)加载到此地址并跳转执行

- **0x8200**: asmhead.nas的加载地址
  - IPL将从磁盘第2扇区开始的数据加载到此处
  - 选择此地址是因为它在常规内存中，远离BIOS数据区

- **0x8400**: C代码(bootpack)的实际入口地址
  - 0x8200 + 512字节 = 0x8400
  - asmhead.bin固定为512字节，bootpack紧随其后

#### VGA显存地址
- **0xA0000**: VGA图形模式显存起始地址
  - 这是VGA标准定义的图形显存物理地址
  - 在保护模式下可以直接访问进行像素绘制
  - 320x200x8位模式下，需要64KB显存(320×200=64000字节)

#### BOOT_INFO数据区地址
这些地址用于在汇编和C代码间传递系统信息：
- **0x0FF0**: 磁盘柱面数(CYLS)
- **0x0FF1**: 键盘LED状态(LEDS)
- **0x0FF2**: 显示模式(VMODE)
- **0x0FF4**: 屏幕宽度(SCRNX)
- **0x0FF6**: 屏幕高度(SCRNY)
- **0x0FF8**: 显存地址(VRAM)

这些地址位于0x0FF0-0x0FFF区域，是BIOS数据区的未使用部分。

### BIOS中断和端口

#### BIOS中断号
- **INT 0x10**: 视频服务中断
  - AH=0x00: 设置显示模式
  - AH=0x0E: 字符显示服务
  - AL=0x13: VGA 320x200x256色模式

- **INT 0x13**: 磁盘服务中断
  - AH=0x02: 读扇区功能
  - AH=0x00: 重置磁盘

- **INT 0x16**: 键盘服务中断
  - AH=0x02: 获取键盘状态

#### I/O端口地址
- **0x21, 0xA1**: PIC(可编程中断控制器)屏蔽寄存器
  - 用于禁用所有硬件中断
  - 0xFF表示屏蔽所有中断线

- **0x60, 0x64**: 键盘控制器端口
  - 用于启用A20地址线
  - A20地址线控制CPU能否访问1MB以上内存

### FAT12文件系统参数

引导扇区包含标准FAT12格式参数：
- **512**: 每扇区字节数
- **2880**: 1.44MB软盘总扇区数(1440KB×1024/512=2880)
- **0xF0**: 软盘介质描述符
- **224**: 根目录最大文件数
- **18**: 每磁道扇区数
- **2**: 磁头数(双面软盘)

### 引导签名
- **0x55AA**: 引导扇区签名
  - 位于扇区的最后两个字节(510-511字节)
  - BIOS通过检查此签名确认这是有效的引导扇区
  - 必须是小端序：先0x55后0xAA

### GDT(全局描述符表)相关

- **8×3-1 = 23**: GDT大小限制
  - 包含3个描述符：空描述符、数据段、代码段
  - 每个描述符8字节，共24字节，限制为23

- **0x9200, 0x9A00**: 段描述符类型字段
  - 0x9200: 数据段(可读写)
  - 0x9A00: 代码段(可执行)

- **0x00CF**: 段限制高4位和标志
  - G位=1(4KB粒度)，D位=1(32位段)

### 堆栈和内存布局

- **0x310000**: 堆栈指针初始值(约3MB处)
  - 选择较高地址避免与代码和数据冲突
  - 为堆栈预留足够空间

## 启动流程

1. **BIOS阶段**: 加载IPL到0x7C00并执行
2. **IPL阶段**: 从磁盘读取system.bin到0x8200
3. **ASMHEAD阶段**: 设置VGA模式，切换到保护模式
4. **BOOTPACK阶段**: 执行C代码主程序

## 调试技巧

代码中使用颜色条纹作为执行标记：
- 白色(15): 实模式VGA测试
- 红色(4): 实模式第二条线
- 绿色(2): 实模式第三条线
- 蓝色(1): 保护模式测试
- 黄色(14): C代码执行标记
- 青色(11): C代码第二标记
- 品红色(13): C代码中心方块
- 红蓝条纹: C代码底部标记

## 编译说明

需要以下工具链：
- NASM: 汇编器
- x86_64-elf-gcc: 交叉编译器
- x86_64-elf-ld: 链接器
- QEMU: 虚拟机

## 参考资料
- [30dayMakeOS](https://github.com/yourtion/30dayMakeOS)
- [0x86 BIOS 中断向量表](https://www.cnblogs.com/jadeshu/p/10663505.html)
- [0x86 实模式物理内存布局](https://www.cnblogs.com/HachikoT/p/16974147.html)
- [VGA硬件编程](http://www.osdever.net/FreeVGA/vga/vga.htm)
- [Intel 80386手册](https://css.csail.mit.edu/6.858/2014/readings/i386.pdf)