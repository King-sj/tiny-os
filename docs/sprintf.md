// sprintf的扩展功能测试和文档

## sprintf 功能说明

我们的sprintf实现支持以下格式说明符：

### 基本格式说明符
- `%d` - 十进制整数（支持负数）
- `%u` - 无符号十进制整数
- `%x` - 小写十六进制整数
- `%X` - 大写十六进制整数
- `%o` - 八进制整数
- `%c` - 单个字符
- `%s` - 字符串
- `%p` - 指针地址（自动添加0x前缀）
- `%%` - 字面量百分号

### 使用示例

```c
char buffer[256];

// 基本整数
sprintf(buffer, "Number: %d", 42);
// 输出: "Number: 42"

// 负数支持
sprintf(buffer, "Negative: %d", -123);
// 输出: "Negative: -123"

// 多个参数
sprintf(buffer, "计算: %d + %d = %d", 10, 20, 30);
// 输出: "计算: 10 + 20 = 30"

// 不同进制
sprintf(buffer, "DEC:%d, HEX:0x%x, OCT:%o", 64, 64, 64);
// 输出: "DEC:64, HEX:0x40, OCT:100"

// 大小写十六进制
sprintf(buffer, "小写: 0x%x, 大写: 0x%X", 255, 255);
// 输出: "小写: 0xff, 大写: 0xFF"

// 字符和字符串
sprintf(buffer, "字符: %c, 字符串: %s", 'A', "Hello");
// 输出: "字符: A, 字符串: Hello"

// 指针地址
void *ptr = (void*)0x280000;
sprintf(buffer, "地址: %p", ptr);
// 输出: "地址: 0x280000"

// 无符号整数
sprintf(buffer, "无符号: %u", 4294967295U);
// 输出: "无符号: 4294967295"

// 转义百分号
sprintf(buffer, "进度: %d%%", 75);
// 输出: "进度: 75%"
```

### 安全版本 snprintf

```c
char buffer[50];

// 限制输出长度，防止缓冲区溢出
int written = snprintf(buffer, sizeof(buffer), "很长的字符串: %s", "这是一个非常长的字符串...");
// 返回实际写入的字符数，如果超出缓冲区则截断
```

### 实现特点

1. **完整的可变参数支持**:
   - 自定义va_list实现，无需外部库依赖
   - 正确处理参数对齐和类型转换

2. **丰富的格式支持**:
   - 支持所有常用格式说明符
   - 正确处理大小写十六进制转换
   - 支持八进制和无符号整数

3. **安全性考虑**:
   - sprintf: 高性能但需要调用者保证缓冲区足够大
   - snprintf: 安全版本，防止缓冲区溢出

4. **错误处理**:
   - 对于不支持的格式，会原样输出
   - snprintf对无效参数返回-1

5. **返回值**:
   - 返回实际写入的字符数（不包括结束符）
   - 便于链式操作和长度检查

6. **向后兼容**:
   - 保留原有的简单函数接口
   - 可以逐步迁移现有代码

### 技术实现细节

#### 可变参数处理
```c
typedef char *va_list;
#define va_start(ap, last) (ap = (va_list)(&last + 1))
#define va_arg(ap, type) (*(type*)((ap += sizeof(type)) - sizeof(type)))
#define va_end(ap) (ap = (va_list)0)
```

#### 汇编辅助函数
- `int_to_str()`: 高效的整数到字符串转换，支持任意进制
- `str_len()`: 快速字符串长度计算
- `str_copy()`: 安全的字符串复制

#### 内存布局考虑
- 在32位系统中，所有参数至少按4字节对齐
- 指针和int具有相同大小，转换安全
- char参数被提升为int传递

### 性能特点

1. **高效的数字转换**: 使用汇编实现的整数转换算法
2. **最小化内存操作**: 直接在目标缓冲区构建字符串
3. **单遍扫描**: 格式字符串只扫描一次
4. **无递归调用**: 避免栈溢出风险

### 使用建议

1. **缓冲区大小**: 为sprintf预留足够空间，或使用snprintf
2. **格式字符串**: 确保格式说明符与参数类型匹配
3. **性能考虑**: sprintf比snprintf略快，但snprintf更安全
4. **调试信息**: 返回值可用于验证格式化是否成功

### 限制说明

1. **字段宽度**: 目前不支持字段宽度指定（如%10d）
2. **精度控制**: 不支持精度指定（如%.2f）
3. **浮点数**: 不支持浮点数格式（%f, %g等）
4. **长度修饰符**: 不支持长度修饰符（如%ld, %ll等）

这些限制是为了保持实现简单和高效，在操作系统内核中通常足够使用。
